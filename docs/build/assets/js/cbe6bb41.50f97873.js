"use strict";(globalThis.webpackChunkkafka_backup_docs=globalThis.webpackChunkkafka_backup_docs||[]).push([[2348],{8453:(e,n,a)=>{a.d(n,{R:()=>c,x:()=>o});var s=a(6540);const r={},t=s.createContext(r);function c(e){const n=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),s.createElement(t.Provider,{value:n},e.children)}},8552:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>i,contentTitle:()=>o,default:()=>u,frontMatter:()=>c,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"examples/aws-lambda","title":"AWS Lambda","description":"Backup and restore Kafka for AWS Lambda consumers","source":"@site/docs/examples/aws-lambda.md","sourceDirName":"examples","slug":"/examples/aws-lambda","permalink":"/examples/aws-lambda","draft":false,"unlisted":false,"editUrl":"https://github.com/osodevops/kafka-backup-docs/tree/main/docs/docs/examples/aws-lambda.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"title":"AWS Lambda","description":"Backup and restore Kafka for AWS Lambda consumers","sidebar_position":3},"sidebar":"docsSidebar","previous":{"title":"Spring Boot","permalink":"/examples/spring-boot"},"next":{"title":"Multi-Cluster DR","permalink":"/examples/multi-cluster-dr"}}');var r=a(4848),t=a(8453);const c={title:"AWS Lambda",description:"Backup and restore Kafka for AWS Lambda consumers",sidebar_position:3},o="AWS Lambda Example",i={},l=[{value:"Lambda with MSK Architecture",id:"lambda-with-msk-architecture",level:2},{value:"Lambda MSK Event Source",id:"lambda-msk-event-source",level:2},{value:"Event Source Mapping Configuration",id:"event-source-mapping-configuration",level:3},{value:"Backup Configuration",id:"backup-configuration",level:2},{value:"Backup from Amazon MSK",id:"backup-from-amazon-msk",level:3},{value:"IAM Authentication",id:"iam-authentication",level:3},{value:"Lambda Consumer Group Handling",id:"lambda-consumer-group-handling",level:2},{value:"Understanding Lambda Consumer Groups",id:"understanding-lambda-consumer-groups",level:3},{value:"Finding Lambda Consumer Group",id:"finding-lambda-consumer-group",level:3},{value:"Backup with Lambda Consumer Group",id:"backup-with-lambda-consumer-group",level:3},{value:"Restore Strategies",id:"restore-strategies",level:2},{value:"Strategy 1: Restore and Reset Lambda",id:"strategy-1-restore-and-reset-lambda",level:3},{value:"Strategy 2: PITR with Lambda",id:"strategy-2-pitr-with-lambda",level:3},{value:"Strategy 3: Resume from Position",id:"strategy-3-resume-from-position",level:3},{value:"AWS Lambda Function for Backup",id:"aws-lambda-function-for-backup",level:2},{value:"Lambda Layer for kafka-backup",id:"lambda-layer-for-kafka-backup",level:3},{value:"EventBridge Scheduled Backups",id:"eventbridge-scheduled-backups",level:2},{value:"CloudWatch Event Rule",id:"cloudwatch-event-rule",level:3},{value:"Terraform Configuration",id:"terraform-configuration",level:3},{value:"DLQ Integration",id:"dlq-integration",level:2},{value:"Backup DLQ Messages",id:"backup-dlq-messages",level:3},{value:"Restore Failed Messages",id:"restore-failed-messages",level:3},{value:"Cross-Region DR",id:"cross-region-dr",level:2},{value:"Backup in Primary Region",id:"backup-in-primary-region",level:3},{value:"Restore in DR Region",id:"restore-in-dr-region",level:3},{value:"Monitoring",id:"monitoring",level:2},{value:"CloudWatch Metrics",id:"cloudwatch-metrics",level:3},{value:"CloudWatch Alarms",id:"cloudwatch-alarms",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"Next Steps",id:"next-steps",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"aws-lambda-example",children:"AWS Lambda Example"})}),"\n",(0,r.jsx)(n.p,{children:"This guide shows how to backup and restore Kafka data consumed by AWS Lambda functions using Amazon MSK as an event source."}),"\n",(0,r.jsx)(n.h2,{id:"lambda-with-msk-architecture",children:"Lambda with MSK Architecture"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                         AWS Account                                  \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                                      \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510         \u2502\n\u2502  \u2502    Amazon    \u2502     \u2502   Lambda     \u2502     \u2502    Other     \u2502         \u2502\n\u2502  \u2502     MSK      \u2502\u2500\u2500\u2500\u2500\u25b6\u2502  Function    \u2502\u2500\u2500\u2500\u2500\u25b6\u2502   Services   \u2502         \u2502\n\u2502  \u2502              \u2502     \u2502              \u2502     \u2502  (DynamoDB,  \u2502         \u2502\n\u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502     \u2502              \u2502     \u2502   S3, etc)   \u2502         \u2502\n\u2502  \u2502  \u2502 orders \u2502  \u2502     \u2502              \u2502     \u2502              \u2502         \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518         \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                                                    \u2502\n\u2502        \u2502                                                             \u2502\n\u2502        \u2502 Backup                                                      \u2502\n\u2502        \u25bc                                                             \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                                                    \u2502\n\u2502  \u2502   S3 Bucket  \u2502                                                    \u2502\n\u2502  \u2502   (Backups)  \u2502                                                    \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                                                    \u2502\n\u2502                                                                      \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,r.jsx)(n.h2,{id:"lambda-msk-event-source",children:"Lambda MSK Event Source"}),"\n",(0,r.jsx)(n.p,{children:"AWS Lambda can consume from MSK/Kafka using Event Source Mapping:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// Lambda function receiving Kafka events\nexports.handler = async (event) => {\n    for (const record of event.records) {\n        for (const topicRecord of record.value) {\n            const key = Buffer.from(topicRecord.key, 'base64').toString();\n            const value = Buffer.from(topicRecord.value, 'base64').toString();\n            const offset = topicRecord.offset;\n\n            console.log(`Processing record: key=${key}, offset=${offset}`);\n\n            // Process the message\n            await processOrder(JSON.parse(value));\n        }\n    }\n\n    return { statusCode: 200 };\n};\n"})}),"\n",(0,r.jsx)(n.h3,{id:"event-source-mapping-configuration",children:"Event Source Mapping Configuration"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "EventSourceArn": "arn:aws:kafka:us-west-2:123456789:cluster/my-cluster/abc123",\n  "FunctionName": "order-processor",\n  "Topics": ["orders"],\n  "StartingPosition": "LATEST",\n  "BatchSize": 100,\n  "MaximumBatchingWindowInSeconds": 5,\n  "DestinationConfig": {\n    "OnFailure": {\n      "Destination": "arn:aws:sqs:us-west-2:123456789:orders-dlq"\n    }\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"backup-configuration",children:"Backup Configuration"}),"\n",(0,r.jsx)(n.h3,{id:"backup-from-amazon-msk",children:"Backup from Amazon MSK"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",metastring:'title="msk-backup.yaml"',children:'mode: backup\nbackup_id: "msk-orders-${TIMESTAMP}"\n\nsource:\n  bootstrap_servers:\n    - b-1.my-cluster.abc123.kafka.us-west-2.amazonaws.com:9092\n    - b-2.my-cluster.abc123.kafka.us-west-2.amazonaws.com:9092\n  security:\n    security_protocol: SASL_SSL\n    sasl_mechanism: AWS_MSK_IAM\n\n  topics:\n    include:\n      - orders\n      - order-events\n      - notifications\n\nstorage:\n  backend: s3\n  bucket: kafka-backups\n  region: us-west-2\n  prefix: msk/orders\n\nbackup:\n  compression: zstd\n  include_offset_headers: true\n  source_cluster_id: "msk-production"\n'})}),"\n",(0,r.jsx)(n.h3,{id:"iam-authentication",children:"IAM Authentication"}),"\n",(0,r.jsx)(n.p,{children:"For MSK with IAM authentication:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"source:\n  security:\n    security_protocol: SASL_SSL\n    sasl_mechanism: AWS_MSK_IAM\n    # Uses default credential chain (IAM role, env vars, etc.)\n"})}),"\n",(0,r.jsx)(n.p,{children:"IAM Policy for backup:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "Version": "2012-10-17",\n  "Statement": [\n    {\n      "Effect": "Allow",\n      "Action": [\n        "kafka-cluster:Connect",\n        "kafka-cluster:DescribeTopic",\n        "kafka-cluster:ReadData",\n        "kafka-cluster:DescribeGroup"\n      ],\n      "Resource": [\n        "arn:aws:kafka:us-west-2:123456789:cluster/my-cluster/*",\n        "arn:aws:kafka:us-west-2:123456789:topic/my-cluster/*",\n        "arn:aws:kafka:us-west-2:123456789:group/my-cluster/*"\n      ]\n    },\n    {\n      "Effect": "Allow",\n      "Action": [\n        "s3:PutObject",\n        "s3:GetObject",\n        "s3:ListBucket"\n      ],\n      "Resource": [\n        "arn:aws:s3:::kafka-backups",\n        "arn:aws:s3:::kafka-backups/*"\n      ]\n    }\n  ]\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"lambda-consumer-group-handling",children:"Lambda Consumer Group Handling"}),"\n",(0,r.jsx)(n.h3,{id:"understanding-lambda-consumer-groups",children:"Understanding Lambda Consumer Groups"}),"\n",(0,r.jsx)(n.p,{children:"Lambda uses auto-generated consumer group IDs:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Consumer Group ID Pattern:\namazon.lambda.{event-source-uuid}\n\nExample:\namazon.lambda.12345678-1234-1234-1234-123456789012\n"})}),"\n",(0,r.jsx)(n.h3,{id:"finding-lambda-consumer-group",children:"Finding Lambda Consumer Group"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# List consumer groups\naws kafka list-groups \\\n  --cluster-arn arn:aws:kafka:us-west-2:123456789:cluster/my-cluster/abc123\n\n# Or via Kafka tools\nkafka-consumer-groups \\\n  --bootstrap-server b-1.my-cluster.abc123.kafka.us-west-2.amazonaws.com:9092 \\\n  --list \\\n  --command-config msk.properties\n"})}),"\n",(0,r.jsx)(n.h3,{id:"backup-with-lambda-consumer-group",children:"Backup with Lambda Consumer Group"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'backup:\n  include_offset_headers: true\n  source_cluster_id: "msk-production"\n\n  # Track Lambda consumer position\n  consumer_groups:\n    - "amazon.lambda.12345678-1234-1234-1234-123456789012"\n'})}),"\n",(0,r.jsx)(n.h2,{id:"restore-strategies",children:"Restore Strategies"}),"\n",(0,r.jsx)(n.h3,{id:"strategy-1-restore-and-reset-lambda",children:"Strategy 1: Restore and Reset Lambda"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",metastring:'title="msk-restore.yaml"',children:'mode: restore\nbackup_id: "msk-orders-20241201"\n\ntarget:\n  bootstrap_servers:\n    - b-1.my-cluster.abc123.kafka.us-west-2.amazonaws.com:9092\n  security:\n    security_protocol: SASL_SSL\n    sasl_mechanism: AWS_MSK_IAM\n\nstorage:\n  backend: s3\n  bucket: kafka-backups\n  prefix: msk/orders\n\nrestore:\n  include_original_offset_header: true\n'})}),"\n",(0,r.jsx)(n.p,{children:"After restore, reset Lambda event source:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Delete and recreate event source mapping\naws lambda delete-event-source-mapping \\\n  --uuid 12345678-1234-1234-1234-123456789012\n\naws lambda create-event-source-mapping \\\n  --function-name order-processor \\\n  --event-source-arn arn:aws:kafka:us-west-2:123456789:cluster/my-cluster/abc123 \\\n  --topics orders \\\n  --starting-position TRIM_HORIZON  # Start from beginning\n"})}),"\n",(0,r.jsx)(n.h3,{id:"strategy-2-pitr-with-lambda",children:"Strategy 2: PITR with Lambda"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"restore:\n  time_window_end: 1701450000000\n\n  # Lambda will need to start from TRIM_HORIZON\n  # to process restored messages\n"})}),"\n",(0,r.jsx)(n.h3,{id:"strategy-3-resume-from-position",children:"Strategy 3: Resume from Position"}),"\n",(0,r.jsx)(n.p,{children:"For resuming exactly where Lambda left off:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Get current Lambda offset position\nOFFSET=$(kafka-consumer-groups \\\n  --bootstrap-server b-1.my-cluster.abc123.kafka.us-west-2.amazonaws.com:9092 \\\n  --group amazon.lambda.12345678-1234-1234-1234-123456789012 \\\n  --describe \\\n  --command-config msk.properties | grep orders | awk '{print $4}')\n\n# Note: Lambda event source mapping doesn't support custom offset\n# Must use TRIM_HORIZON or LATEST\n"})}),"\n",(0,r.jsx)(n.h2,{id:"aws-lambda-function-for-backup",children:"AWS Lambda Function for Backup"}),"\n",(0,r.jsx)(n.p,{children:"Run backups using Lambda:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// backup-lambda.js\nconst { execSync } = require('child_process');\nconst path = require('path');\n\nexports.handler = async (event) => {\n    const backupId = `msk-backup-${Date.now()}`;\n\n    const config = {\n        mode: 'backup',\n        backup_id: backupId,\n        source: {\n            bootstrap_servers: [process.env.MSK_BOOTSTRAP_SERVERS],\n            security: {\n                security_protocol: 'SASL_SSL',\n                sasl_mechanism: 'AWS_MSK_IAM'\n            },\n            topics: {\n                include: event.topics || ['orders']\n            }\n        },\n        storage: {\n            backend: 's3',\n            bucket: process.env.BACKUP_BUCKET,\n            prefix: 'msk-backups'\n        },\n        backup: {\n            compression: 'zstd',\n            include_offset_headers: true\n        }\n    };\n\n    // Write config\n    const configPath = '/tmp/backup-config.yaml';\n    require('fs').writeFileSync(configPath, require('yaml').stringify(config));\n\n    // Execute backup\n    try {\n        execSync(`/opt/kafka-backup backup --config ${configPath}`, {\n            stdio: 'inherit'\n        });\n\n        return {\n            statusCode: 200,\n            body: JSON.stringify({ backup_id: backupId })\n        };\n    } catch (error) {\n        console.error('Backup failed:', error);\n        throw error;\n    }\n};\n"})}),"\n",(0,r.jsx)(n.h3,{id:"lambda-layer-for-kafka-backup",children:"Lambda Layer for kafka-backup"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dockerfile",children:"# Dockerfile for Lambda layer\nFROM amazonlinux:2\n\nRUN yum install -y curl tar gzip\n\n# Download kafka-backup binary\nRUN curl -L https://github.com/osodevops/kafka-backup/releases/latest/download/kafka-backup-linux-amd64.tar.gz | \\\n    tar xz -C /opt\n\n# Create layer structure\nRUN mkdir -p /opt/layer && \\\n    cp /opt/kafka-backup /opt/layer/\n\n# Package layer\nWORKDIR /opt/layer\nRUN zip -r /opt/layer.zip .\n"})}),"\n",(0,r.jsx)(n.h2,{id:"eventbridge-scheduled-backups",children:"EventBridge Scheduled Backups"}),"\n",(0,r.jsx)(n.h3,{id:"cloudwatch-event-rule",children:"CloudWatch Event Rule"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "Name": "msk-backup-schedule",\n  "ScheduleExpression": "rate(1 hour)",\n  "State": "ENABLED",\n  "Targets": [\n    {\n      "Id": "backup-lambda",\n      "Arn": "arn:aws:lambda:us-west-2:123456789:function:msk-backup",\n      "Input": "{\\"topics\\": [\\"orders\\", \\"order-events\\"]}"\n    }\n  ]\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"terraform-configuration",children:"Terraform Configuration"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'resource "aws_cloudwatch_event_rule" "backup_schedule" {\n  name                = "msk-backup-schedule"\n  description         = "Trigger MSK backup every hour"\n  schedule_expression = "rate(1 hour)"\n}\n\nresource "aws_cloudwatch_event_target" "backup_lambda" {\n  rule      = aws_cloudwatch_event_rule.backup_schedule.name\n  target_id = "backup-lambda"\n  arn       = aws_lambda_function.backup.arn\n\n  input = jsonencode({\n    topics = ["orders", "order-events"]\n  })\n}\n\nresource "aws_lambda_permission" "allow_eventbridge" {\n  statement_id  = "AllowExecutionFromEventBridge"\n  action        = "lambda:InvokeFunction"\n  function_name = aws_lambda_function.backup.function_name\n  principal     = "events.amazonaws.com"\n  source_arn    = aws_cloudwatch_event_rule.backup_schedule.arn\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"dlq-integration",children:"DLQ Integration"}),"\n",(0,r.jsx)(n.h3,{id:"backup-dlq-messages",children:"Backup DLQ Messages"}),"\n",(0,r.jsx)(n.p,{children:"When Lambda fails, messages go to SQS DLQ. Backup both:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"source:\n  topics:\n    include:\n      - orders\n\n# Also backup SQS DLQ separately (different tool needed)\n"})}),"\n",(0,r.jsx)(n.h3,{id:"restore-failed-messages",children:"Restore Failed Messages"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// Lambda to move DLQ messages back to Kafka\nconst AWS = require('aws-sdk');\nconst { Kafka } = require('kafkajs');\n\nexports.handler = async (event) => {\n    const sqs = new AWS.SQS();\n    const kafka = new Kafka({\n        clientId: 'dlq-replayer',\n        brokers: [process.env.MSK_BOOTSTRAP_SERVERS],\n        ssl: true,\n        sasl: {\n            mechanism: 'aws',\n            authorizationIdentity: 'msk-admin',\n            accessKeyId: process.env.AWS_ACCESS_KEY_ID,\n            secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY,\n        }\n    });\n\n    const producer = kafka.producer();\n    await producer.connect();\n\n    // Receive messages from DLQ\n    const response = await sqs.receiveMessage({\n        QueueUrl: process.env.DLQ_URL,\n        MaxNumberOfMessages: 10\n    }).promise();\n\n    for (const message of response.Messages || []) {\n        const kafkaMessage = JSON.parse(message.Body);\n\n        // Resend to Kafka\n        await producer.send({\n            topic: 'orders',\n            messages: [{ key: kafkaMessage.key, value: kafkaMessage.value }]\n        });\n\n        // Delete from DLQ\n        await sqs.deleteMessage({\n            QueueUrl: process.env.DLQ_URL,\n            ReceiptHandle: message.ReceiptHandle\n        }).promise();\n    }\n\n    await producer.disconnect();\n};\n"})}),"\n",(0,r.jsx)(n.h2,{id:"cross-region-dr",children:"Cross-Region DR"}),"\n",(0,r.jsx)(n.h3,{id:"backup-in-primary-region",children:"Backup in Primary Region"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",metastring:'title="backup-us-west-2.yaml"',children:"source:\n  bootstrap_servers:\n    - b-1.primary-cluster.kafka.us-west-2.amazonaws.com:9092\n\nstorage:\n  backend: s3\n  bucket: kafka-backups-us-west-2\n  region: us-west-2\n  prefix: primary\n\n  # Enable cross-region replication in S3\n"})}),"\n",(0,r.jsx)(n.h3,{id:"restore-in-dr-region",children:"Restore in DR Region"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",metastring:'title="restore-us-east-1.yaml"',children:"target:\n  bootstrap_servers:\n    - b-1.dr-cluster.kafka.us-east-1.amazonaws.com:9092\n\nstorage:\n  backend: s3\n  bucket: kafka-backups-us-east-1  # Replicated bucket\n  region: us-east-1\n  prefix: primary\n"})}),"\n",(0,r.jsx)(n.h2,{id:"monitoring",children:"Monitoring"}),"\n",(0,r.jsx)(n.h3,{id:"cloudwatch-metrics",children:"CloudWatch Metrics"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// Lambda backup function with metrics\nconst AWS = require('aws-sdk');\nconst cloudwatch = new AWS.CloudWatch();\n\nasync function reportMetrics(backupStats) {\n    await cloudwatch.putMetricData({\n        Namespace: 'KafkaBackup',\n        MetricData: [\n            {\n                MetricName: 'RecordsBackedUp',\n                Value: backupStats.records,\n                Unit: 'Count'\n            },\n            {\n                MetricName: 'BackupDurationSeconds',\n                Value: backupStats.duration,\n                Unit: 'Seconds'\n            },\n            {\n                MetricName: 'BackupSizeBytes',\n                Value: backupStats.bytes,\n                Unit: 'Bytes'\n            }\n        ]\n    }).promise();\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"cloudwatch-alarms",children:"CloudWatch Alarms"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "AlarmName": "KafkaBackupFailed",\n  "MetricName": "Errors",\n  "Namespace": "AWS/Lambda",\n  "Dimensions": [\n    {\n      "Name": "FunctionName",\n      "Value": "msk-backup"\n    }\n  ],\n  "Statistic": "Sum",\n  "Period": 3600,\n  "EvaluationPeriods": 1,\n  "Threshold": 1,\n  "ComparisonOperator": "GreaterThanOrEqualToThreshold",\n  "AlarmActions": ["arn:aws:sns:us-west-2:123456789:alerts"]\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Use IAM authentication"})," for MSK when possible"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Schedule backups"})," via EventBridge"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Enable S3 cross-region replication"})," for DR"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Monitor Lambda errors"})," with CloudWatch"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Handle DLQ messages"})," separately"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Test restore in DR region"})," regularly"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"./multi-cluster-dr",children:"Multi-Cluster DR"})," - Complex DR scenarios"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"../deployment/cloud-setup/aws-s3",children:"AWS S3 Setup"})," - S3 configuration"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"../use-cases/disaster-recovery",children:"Disaster Recovery"})," - DR planning"]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}}}]);