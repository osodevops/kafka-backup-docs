"use strict";(globalThis.webpackChunkkafka_backup_docs=globalThis.webpackChunkkafka_backup_docs||[]).push([[2567],{8453:(e,n,i)=>{i.d(n,{R:()=>o,x:()=>a});var s=i(6540);const t={},r=s.createContext(t);function o(e){const n=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),s.createElement(r.Provider,{value:n},e.children)}},9836:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>p,frontMatter:()=>o,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"guides/restore-pitr","title":"Point-in-Time Recovery","description":"Restore Kafka data to a specific point in time using PITR","source":"@site/docs/guides/restore-pitr.md","sourceDirName":"guides","slug":"/guides/restore-pitr","permalink":"/guides/restore-pitr","draft":false,"unlisted":false,"editUrl":"https://github.com/osodevops/kafka-backup-docs/tree/main/docs/docs/guides/restore-pitr.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"title":"Point-in-Time Recovery","description":"Restore Kafka data to a specific point in time using PITR","sidebar_position":2},"sidebar":"docsSidebar","previous":{"title":"Backup to S3","permalink":"/guides/backup-to-s3"},"next":{"title":"Offset Management","permalink":"/guides/offset-management"}}');var t=i(4848),r=i(8453);const o={title:"Point-in-Time Recovery",description:"Restore Kafka data to a specific point in time using PITR",sidebar_position:2},a="Point-in-Time Recovery (PITR)",d={},c=[{value:"What is PITR?",id:"what-is-pitr",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Understanding Time Windows",id:"understanding-time-windows",level:2},{value:"Step 1: Find Available Time Range",id:"step-1-find-available-time-range",level:2},{value:"Step 2: Convert Timestamps",id:"step-2-convert-timestamps",level:2},{value:"Using Linux/macOS",id:"using-linuxmacos",level:3},{value:"Using Python",id:"using-python",level:3},{value:"Common Time Windows",id:"common-time-windows",level:3},{value:"Step 3: Create PITR Configuration",id:"step-3-create-pitr-configuration",level:2},{value:"Step 4: Validate Before Restore",id:"step-4-validate-before-restore",level:2},{value:"Step 5: Execute PITR Restore",id:"step-5-execute-pitr-restore",level:2},{value:"Step 6: Verify Restored Data",id:"step-6-verify-restored-data",level:2},{value:"Advanced PITR Scenarios",id:"advanced-pitr-scenarios",level:2},{value:"Restore to &quot;Just Before&quot; an Incident",id:"restore-to-just-before-an-incident",level:3},{value:"Restore Specific Partitions Only",id:"restore-specific-partitions-only",level:3},{value:"Restore with Partition Remapping",id:"restore-with-partition-remapping",level:3},{value:"Continuous Time Window (Open-Ended)",id:"continuous-time-window-open-ended",level:3},{value:"Consumer Offset Handling After PITR",id:"consumer-offset-handling-after-pitr",level:2},{value:"Option 1: Reset to Earliest",id:"option-1-reset-to-earliest",level:3},{value:"Option 2: Use Offset Headers",id:"option-2-use-offset-headers",level:3},{value:"Option 3: Three-Phase Restore",id:"option-3-three-phase-restore",level:3},{value:"Performance Considerations",id:"performance-considerations",level:2},{value:"Optimization Tips",id:"optimization-tips",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"No Records in Time Window",id:"no-records-in-time-window",level:3},{value:"Timestamp Mismatch",id:"timestamp-mismatch",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"Next Steps",id:"next-steps",level:2}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"point-in-time-recovery-pitr",children:"Point-in-Time Recovery (PITR)"})}),"\n",(0,t.jsx)(n.p,{children:"Restore Kafka data to any specific moment within your backup window with millisecond precision."}),"\n",(0,t.jsx)(n.h2,{id:"what-is-pitr",children:"What is PITR?"}),"\n",(0,t.jsx)(n.p,{children:"Point-in-Time Recovery allows you to restore data from a backup to a specific timestamp, rather than restoring the entire backup. This is useful for:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Disaster recovery"}),": Restore to just before a data corruption event"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Debugging"}),": Reproduce issues with data from a specific time"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Compliance"}),": Retrieve data as it existed at a particular moment"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Testing"}),": Create test environments with data from specific periods"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Backup created with ",(0,t.jsx)(n.code,{children:"include_offset_headers: true"})]}),"\n",(0,t.jsx)(n.li,{children:"Backup storage accessible"}),"\n",(0,t.jsx)(n.li,{children:"Target Kafka cluster available"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"understanding-time-windows",children:"Understanding Time Windows"}),"\n",(0,t.jsx)(n.p,{children:"When you back up Kafka topics, each message includes its original timestamp. PITR uses these timestamps to filter which messages to restore."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"Backup Timeline:\n\u251c\u2500\u2500 Nov 1, 00:00 \u2500 Backup started\n\u2502   \u251c\u2500\u2500 Message 1 (timestamp: Nov 1, 00:00:01)\n\u2502   \u251c\u2500\u2500 Message 2 (timestamp: Nov 1, 00:00:02)\n\u2502   \u251c\u2500\u2500 ...\n\u2502   \u251c\u2500\u2500 Message N (timestamp: Nov 15, 23:59:59)\n\u2514\u2500\u2500 Nov 15, 23:59 \u2500 Backup ended\n\nPITR Window: Nov 10, 10:00 \u2192 Nov 10, 14:00\nResult: Only messages with timestamps in this 4-hour window are restored\n"})}),"\n",(0,t.jsx)(n.h2,{id:"step-1-find-available-time-range",children:"Step 1: Find Available Time Range"}),"\n",(0,t.jsx)(n.p,{children:"First, check the time range available in your backup:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kafka-backup describe \\\n  --path s3://my-kafka-backups/production \\\n  --backup-id production-backup-001\n"})}),"\n",(0,t.jsx)(n.p,{children:"Output:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"Backup: production-backup-001\n\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n\nTime Range:\n  Earliest Message:  2024-11-01T00:00:00Z\n  Latest Message:    2024-11-15T23:59:59Z\n\nTopics:\n  orders       6 partitions    523,456 records\n  payments     3 partitions    234,567 records\n"})}),"\n",(0,t.jsx)(n.h2,{id:"step-2-convert-timestamps",children:"Step 2: Convert Timestamps"}),"\n",(0,t.jsxs)(n.p,{children:["PITR uses Unix timestamps in ",(0,t.jsx)(n.strong,{children:"milliseconds"}),". Convert your target times:"]}),"\n",(0,t.jsx)(n.h3,{id:"using-linuxmacos",children:"Using Linux/macOS"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Convert ISO timestamp to Unix milliseconds\ndate -d "2024-11-10T10:00:00Z" +%s000\n# Output: 1731236400000\n\ndate -d "2024-11-10T14:00:00Z" +%s000\n# Output: 1731250800000\n'})}),"\n",(0,t.jsx)(n.h3,{id:"using-python",children:"Using Python"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'from datetime import datetime\n\nstart = datetime(2024, 11, 10, 10, 0, 0)\nend = datetime(2024, 11, 10, 14, 0, 0)\n\nprint(f"Start: {int(start.timestamp() * 1000)}")\nprint(f"End: {int(end.timestamp() * 1000)}")\n'})}),"\n",(0,t.jsx)(n.h3,{id:"common-time-windows",children:"Common Time Windows"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Window"}),(0,t.jsx)(n.th,{children:"Start Formula"}),(0,t.jsx)(n.th,{children:"Example"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Last hour"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"now - 3600000"})}),(0,t.jsx)(n.td,{children:"Debugging recent issues"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Last 24 hours"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"now - 86400000"})}),(0,t.jsx)(n.td,{children:"Daily incident recovery"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Specific day"}),(0,t.jsx)(n.td,{children:"Midnight to midnight"}),(0,t.jsx)(n.td,{children:"Compliance reporting"})]})]})]}),"\n",(0,t.jsx)(n.h2,{id:"step-3-create-pitr-configuration",children:"Step 3: Create PITR Configuration"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",metastring:'title="pitr-restore.yaml"',children:'mode: restore\nbackup_id: "production-backup-001"\n\ntarget:\n  bootstrap_servers:\n    - kafka-dr-0.example.com:9092\n    - kafka-dr-1.example.com:9092\n\nstorage:\n  backend: s3\n  bucket: my-kafka-backups\n  region: us-west-2\n  prefix: production\n\nrestore:\n  # Point-in-Time Recovery window\n  time_window_start: 1731236400000  # Nov 10, 2024 10:00:00 UTC\n  time_window_end: 1731250800000    # Nov 10, 2024 14:00:00 UTC\n\n  # Optional: Only restore specific topics\n  # topics:\n  #   - orders\n  #   - payments\n\n  # Optional: Remap topic names\n  topic_mapping:\n    orders: orders_pitr_restore\n    payments: payments_pitr_restore\n\n  # Include original offset in headers for consumer reset\n  include_original_offset_header: true\n\n  # Consumer offset handling\n  consumer_group_strategy: skip\n'})}),"\n",(0,t.jsx)(n.h2,{id:"step-4-validate-before-restore",children:"Step 4: Validate Before Restore"}),"\n",(0,t.jsx)(n.p,{children:"Always validate PITR configuration first:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kafka-backup validate-restore --config pitr-restore.yaml\n"})}),"\n",(0,t.jsx)(n.p,{children:"Output:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"Restore Validation Report\n\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n\nStatus: \u2713 VALID\n\nPITR Time Window:\n  Start: 2024-11-10T10:00:00Z (1731236400000)\n  End:   2024-11-10T14:00:00Z (1731250800000)\n  Duration: 4 hours\n\nData to Restore:\n  Segments matching: 23 of 156\n  Records in window: ~45,678\n  Estimated size: 12.3 MB\n\nTopics:\n  orders   \u2192 orders_pitr_restore    (est. 23,456 records)\n  payments \u2192 payments_pitr_restore  (est. 22,222 records)\n"})}),"\n",(0,t.jsx)(n.h2,{id:"step-5-execute-pitr-restore",children:"Step 5: Execute PITR Restore"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kafka-backup restore --config pitr-restore.yaml\n"})}),"\n",(0,t.jsx)(n.p,{children:"Output:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"[INFO] Starting PITR restore from: production-backup-001\n[INFO] Time window: 2024-11-10T10:00:00Z to 2024-11-10T14:00:00Z\n[INFO] Filtering records by timestamp...\n\n[INFO] Restoring topic: orders \u2192 orders_pitr_restore\n  Records in window: 23,456\n  Restoring partition 0: 3,892 records\n  Restoring partition 1: 3,901 records\n  ...\n\n[INFO] PITR restore completed\n[INFO] Summary:\n  Records Restored: 45,678\n  Skipped (outside window): 477,889\n  Duration: 2m 15s\n"})}),"\n",(0,t.jsx)(n.h2,{id:"step-6-verify-restored-data",children:"Step 6: Verify Restored Data"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Check topic was created\nkafka-topics --bootstrap-server kafka-dr:9092 --describe --topic orders_pitr_restore\n\n# Sample messages\nkafka-console-consumer \\\n  --bootstrap-server kafka-dr:9092 \\\n  --topic orders_pitr_restore \\\n  --from-beginning \\\n  --max-messages 5 \\\n  --property print.timestamp=true\n"})}),"\n",(0,t.jsx)(n.h2,{id:"advanced-pitr-scenarios",children:"Advanced PITR Scenarios"}),"\n",(0,t.jsx)(n.h3,{id:"restore-to-just-before-an-incident",children:'Restore to "Just Before" an Incident'}),"\n",(0,t.jsx)(n.p,{children:"If you know an incident occurred at 14:32:15 UTC:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"restore:\n  # Restore up to 1 minute before the incident\n  time_window_end: 1731251535000  # 14:32:15 - 60000 = 14:31:15\n"})}),"\n",(0,t.jsx)(n.h3,{id:"restore-specific-partitions-only",children:"Restore Specific Partitions Only"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"restore:\n  time_window_start: 1731236400000\n  time_window_end: 1731250800000\n  source_partitions:\n    - 0\n    - 1\n    - 2  # Only restore partitions 0, 1, 2\n"})}),"\n",(0,t.jsx)(n.h3,{id:"restore-with-partition-remapping",children:"Restore with Partition Remapping"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"restore:\n  time_window_start: 1731236400000\n  time_window_end: 1731250800000\n  partition_mapping:\n    0: 0\n    1: 0  # Merge partition 1 into partition 0\n    2: 1  # Move partition 2 to partition 1\n"})}),"\n",(0,t.jsx)(n.h3,{id:"continuous-time-window-open-ended",children:"Continuous Time Window (Open-Ended)"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"restore:\n  # From Nov 10 to latest available\n  time_window_start: 1731236400000\n  # time_window_end: omitted = restore to end of backup\n"})}),"\n",(0,t.jsx)(n.h2,{id:"consumer-offset-handling-after-pitr",children:"Consumer Offset Handling After PITR"}),"\n",(0,t.jsx)(n.p,{children:"After a PITR restore, consumer groups need their offsets adjusted. Since only a subset of messages is restored, offsets will differ."}),"\n",(0,t.jsx)(n.h3,{id:"option-1-reset-to-earliest",children:"Option 1: Reset to Earliest"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kafka-consumer-groups \\\n  --bootstrap-server kafka-dr:9092 \\\n  --group my-consumer-group \\\n  --topic orders_pitr_restore \\\n  --reset-offsets \\\n  --to-earliest \\\n  --execute\n"})}),"\n",(0,t.jsx)(n.h3,{id:"option-2-use-offset-headers",children:"Option 2: Use Offset Headers"}),"\n",(0,t.jsxs)(n.p,{children:["If ",(0,t.jsx)(n.code,{children:"include_original_offset_header: true"})," was set, messages contain their original offsets. Consumers can read this header to track position."]}),"\n",(0,t.jsx)(n.h3,{id:"option-3-three-phase-restore",children:"Option 3: Three-Phase Restore"}),"\n",(0,t.jsx)(n.p,{children:"Use the three-phase restore for automatic offset handling:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"restore:\n  time_window_start: 1731236400000\n  time_window_end: 1731250800000\n  consumer_group_strategy: header-based\n  reset_consumer_offsets: true\n  consumer_groups:\n    - my-consumer-group\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kafka-backup three-phase-restore --config pitr-restore.yaml\n"})}),"\n",(0,t.jsx)(n.h2,{id:"performance-considerations",children:"Performance Considerations"}),"\n",(0,t.jsx)(n.p,{children:"PITR may be slower than full restore because:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"All segments must be scanned to find matching records"}),"\n",(0,t.jsx)(n.li,{children:"Filtering adds CPU overhead"}),"\n",(0,t.jsx)(n.li,{children:"Smaller batches may be written"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"optimization-tips",children:"Optimization Tips"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Use narrower time windows when possible"}),"\n",(0,t.jsxs)(n.li,{children:["Increase ",(0,t.jsx)(n.code,{children:"max_concurrent_partitions"})," for parallelism"]}),"\n",(0,t.jsx)(n.li,{children:"Use faster storage (SSD) for backup data"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,t.jsx)(n.h3,{id:"no-records-in-time-window",children:"No Records in Time Window"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"Warning: No records found in specified time window\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Causes:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Time window is outside backup range"}),"\n",(0,t.jsx)(n.li,{children:"Timestamps are in wrong format (seconds vs milliseconds)"}),"\n",(0,t.jsx)(n.li,{children:"Topic has no data in that period"}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Solution:"})," Check backup time range with ",(0,t.jsx)(n.code,{children:"describe"})," command."]}),"\n",(0,t.jsx)(n.h3,{id:"timestamp-mismatch",children:"Timestamp Mismatch"}),"\n",(0,t.jsx)(n.p,{children:"Messages may have unexpected timestamps if:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Producers set custom timestamps"}),"\n",(0,t.jsx)(n.li,{children:"Messages were replicated with different timestamps"}),"\n",(0,t.jsx)(n.li,{children:"Clock skew between producers"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Always validate first"})," - Use ",(0,t.jsx)(n.code,{children:"validate-restore"})," before executing"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Restore to new topics"})," - Use ",(0,t.jsx)(n.code,{children:"topic_mapping"})," to avoid overwriting"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Document recovery points"})," - Note important timestamps for compliance"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Test regularly"})," - Practice PITR restores before you need them"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Monitor backup timestamps"})," - Ensure backups capture expected time ranges"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"./offset-management",children:"Offset Management"})," - Handle consumer offsets after restore"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"../reference/cli-reference#three-phase-restore",children:"Three-Phase Restore"})," - Automated restore with offset reset"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"../use-cases/disaster-recovery",children:"Disaster Recovery Use Case"})," - DR planning with PITR"]}),"\n"]})]})}function p(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}}}]);