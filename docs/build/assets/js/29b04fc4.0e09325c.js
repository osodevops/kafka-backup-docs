"use strict";(globalThis.webpackChunkkafka_backup_docs=globalThis.webpackChunkkafka_backup_docs||[]).push([[4853],{2612:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>o,contentTitle:()=>s,default:()=>u,frontMatter:()=>c,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"deployment/cloud-setup/azure-blob","title":"Azure Blob Storage Setup","description":"Configure Azure Blob Storage as backend for OSO Kafka Backup","source":"@site/docs/deployment/cloud-setup/azure-blob.md","sourceDirName":"deployment/cloud-setup","slug":"/deployment/cloud-setup/azure-blob","permalink":"/deployment/cloud-setup/azure-blob","draft":false,"unlisted":false,"editUrl":"https://github.com/osodevops/kafka-backup-docs/tree/main/docs/docs/deployment/cloud-setup/azure-blob.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"title":"Azure Blob Storage Setup","description":"Configure Azure Blob Storage as backend for OSO Kafka Backup","sidebar_position":2},"sidebar":"docsSidebar","previous":{"title":"AWS S3 Setup","permalink":"/deployment/cloud-setup/aws-s3"},"next":{"title":"Google Cloud Storage Setup","permalink":"/deployment/cloud-setup/gcs"}}');var t=a(4848),i=a(8453);const c={title:"Azure Blob Storage Setup",description:"Configure Azure Blob Storage as backend for OSO Kafka Backup",sidebar_position:2},s="Azure Blob Storage Setup",o={},l=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Create Storage Account",id:"create-storage-account",level:2},{value:"Using Azure CLI",id:"using-azure-cli",level:3},{value:"Using Terraform",id:"using-terraform",level:3},{value:"Authentication Methods",id:"authentication-methods",level:2},{value:"Storage Account Key",id:"storage-account-key",level:3},{value:"Connection String",id:"connection-string",level:3},{value:"Managed Identity (Azure VMs/AKS)",id:"managed-identity-azure-vmsaks",level:3},{value:"Service Principal",id:"service-principal",level:3},{value:"Configuration",id:"configuration",level:2},{value:"With Storage Account Key",id:"with-storage-account-key",level:3},{value:"With Connection String",id:"with-connection-string",level:3},{value:"With Managed Identity",id:"with-managed-identity",level:3},{value:"Environment Variables",id:"environment-variables",level:2},{value:"AKS Workload Identity",id:"aks-workload-identity",level:2},{value:"Lifecycle Management",id:"lifecycle-management",level:2},{value:"Set Up Lifecycle Policy",id:"set-up-lifecycle-policy",level:3},{value:"Access Tiers",id:"access-tiers",level:2},{value:"Geo-Replication",id:"geo-replication",level:2},{value:"Security Best Practices",id:"security-best-practices",level:2},{value:"Enable Encryption",id:"enable-encryption",level:3},{value:"Configure Firewall",id:"configure-firewall",level:3},{value:"Enable Soft Delete",id:"enable-soft-delete",level:3},{value:"Testing",id:"testing",level:2},{value:"Verify Access",id:"verify-access",level:3},{value:"Test from Application",id:"test-from-application",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Authentication Errors",id:"authentication-errors",level:3},{value:"Network Errors",id:"network-errors",level:3},{value:"Next Steps",id:"next-steps",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"azure-blob-storage-setup",children:"Azure Blob Storage Setup"})}),"\n",(0,t.jsx)(n.p,{children:"Configure Azure Blob Storage for Kafka backups."}),"\n",(0,t.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Azure subscription"}),"\n",(0,t.jsx)(n.li,{children:"Azure CLI installed"}),"\n",(0,t.jsx)(n.li,{children:"Permissions to create storage accounts"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"create-storage-account",children:"Create Storage Account"}),"\n",(0,t.jsx)(n.h3,{id:"using-azure-cli",children:"Using Azure CLI"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Set variables\nRESOURCE_GROUP="kafka-backup-rg"\nSTORAGE_ACCOUNT="kafkabackups$(date +%s)"  # Must be globally unique\nLOCATION="westus2"\n\n# Create resource group\naz group create --name $RESOURCE_GROUP --location $LOCATION\n\n# Create storage account\naz storage account create \\\n  --name $STORAGE_ACCOUNT \\\n  --resource-group $RESOURCE_GROUP \\\n  --location $LOCATION \\\n  --sku Standard_LRS \\\n  --kind StorageV2 \\\n  --min-tls-version TLS1_2 \\\n  --allow-blob-public-access false\n\n# Create container\naz storage container create \\\n  --name kafka-backups \\\n  --account-name $STORAGE_ACCOUNT \\\n  --auth-mode login\n'})}),"\n",(0,t.jsx)(n.h3,{id:"using-terraform",children:"Using Terraform"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-hcl",metastring:'title="azure-storage.tf"',children:'resource "azurerm_resource_group" "kafka_backup" {\n  name     = "kafka-backup-rg"\n  location = "West US 2"\n}\n\nresource "azurerm_storage_account" "kafka_backup" {\n  name                     = "kafkabackups${random_string.suffix.result}"\n  resource_group_name      = azurerm_resource_group.kafka_backup.name\n  location                 = azurerm_resource_group.kafka_backup.location\n  account_tier             = "Standard"\n  account_replication_type = "LRS"\n  min_tls_version          = "TLS1_2"\n\n  blob_properties {\n    versioning_enabled = true\n\n    delete_retention_policy {\n      days = 30\n    }\n  }\n}\n\nresource "azurerm_storage_container" "kafka_backups" {\n  name                  = "kafka-backups"\n  storage_account_name  = azurerm_storage_account.kafka_backup.name\n  container_access_type = "private"\n}\n\nresource "random_string" "suffix" {\n  length  = 8\n  special = false\n  upper   = false\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"authentication-methods",children:"Authentication Methods"}),"\n",(0,t.jsx)(n.h3,{id:"storage-account-key",children:"Storage Account Key"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Get storage account key\naz storage account keys list \\\n  --account-name $STORAGE_ACCOUNT \\\n  --resource-group $RESOURCE_GROUP \\\n  --query "[0].value" -o tsv\n'})}),"\n",(0,t.jsx)(n.h3,{id:"connection-string",children:"Connection String"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Get connection string\naz storage account show-connection-string \\\n  --name $STORAGE_ACCOUNT \\\n  --resource-group $RESOURCE_GROUP \\\n  --query connectionString -o tsv\n"})}),"\n",(0,t.jsx)(n.h3,{id:"managed-identity-azure-vmsaks",children:"Managed Identity (Azure VMs/AKS)"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Enable system-assigned managed identity on VM\naz vm identity assign \\\n  --resource-group $RESOURCE_GROUP \\\n  --name my-vm\n\n# Get principal ID\nPRINCIPAL_ID=$(az vm show \\\n  --resource-group $RESOURCE_GROUP \\\n  --name my-vm \\\n  --query identity.principalId -o tsv)\n\n# Assign Storage Blob Data Contributor role\naz role assignment create \\\n  --role "Storage Blob Data Contributor" \\\n  --assignee $PRINCIPAL_ID \\\n  --scope "/subscriptions/<sub-id>/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.Storage/storageAccounts/$STORAGE_ACCOUNT"\n'})}),"\n",(0,t.jsx)(n.h3,{id:"service-principal",children:"Service Principal"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Create service principal\naz ad sp create-for-rbac \\\n  --name kafka-backup-sp \\\n  --role "Storage Blob Data Contributor" \\\n  --scopes "/subscriptions/<sub-id>/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.Storage/storageAccounts/$STORAGE_ACCOUNT"\n'})}),"\n",(0,t.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,t.jsx)(n.h3,{id:"with-storage-account-key",children:"With Storage Account Key"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",metastring:'title="backup.yaml"',children:"storage:\n  backend: azure\n  container: kafka-backups\n  account_name: kafkabackups123456\n  account_key: ${AZURE_STORAGE_KEY}\n  prefix: production/daily\n"})}),"\n",(0,t.jsx)(n.h3,{id:"with-connection-string",children:"With Connection String"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",metastring:'title="backup.yaml"',children:"storage:\n  backend: azure\n  container: kafka-backups\n  connection_string: ${AZURE_STORAGE_CONNECTION_STRING}\n  prefix: production/daily\n"})}),"\n",(0,t.jsx)(n.h3,{id:"with-managed-identity",children:"With Managed Identity"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",metastring:'title="backup.yaml"',children:"storage:\n  backend: azure\n  container: kafka-backups\n  account_name: kafkabackups123456\n  # No credentials needed - uses managed identity\n  prefix: production/daily\n"})}),"\n",(0,t.jsx)(n.h2,{id:"environment-variables",children:"Environment Variables"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Variable"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"AZURE_STORAGE_ACCOUNT"})}),(0,t.jsx)(n.td,{children:"Storage account name"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"AZURE_STORAGE_KEY"})}),(0,t.jsx)(n.td,{children:"Storage account key"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"AZURE_STORAGE_CONNECTION_STRING"})}),(0,t.jsx)(n.td,{children:"Full connection string"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"AZURE_CLIENT_ID"})}),(0,t.jsx)(n.td,{children:"Service principal client ID"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"AZURE_CLIENT_SECRET"})}),(0,t.jsx)(n.td,{children:"Service principal secret"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"AZURE_TENANT_ID"})}),(0,t.jsx)(n.td,{children:"Azure AD tenant ID"})]})]})]}),"\n",(0,t.jsx)(n.h2,{id:"aks-workload-identity",children:"AKS Workload Identity"}),"\n",(0,t.jsx)(n.p,{children:"For AKS, use workload identity:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Enable workload identity on cluster\naz aks update \\\n  --resource-group $RESOURCE_GROUP \\\n  --name my-aks-cluster \\\n  --enable-oidc-issuer \\\n  --enable-workload-identity\n\n# Create managed identity\naz identity create \\\n  --name kafka-backup-identity \\\n  --resource-group $RESOURCE_GROUP\n\n# Get identity client ID\nCLIENT_ID=$(az identity show \\\n  --name kafka-backup-identity \\\n  --resource-group $RESOURCE_GROUP \\\n  --query clientId -o tsv)\n\n# Assign role\naz role assignment create \\\n  --role "Storage Blob Data Contributor" \\\n  --assignee $CLIENT_ID \\\n  --scope "/subscriptions/<sub-id>/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.Storage/storageAccounts/$STORAGE_ACCOUNT"\n\n# Create federated credential\naz identity federated-credential create \\\n  --name kafka-backup-federated \\\n  --identity-name kafka-backup-identity \\\n  --resource-group $RESOURCE_GROUP \\\n  --issuer $(az aks show --name my-aks-cluster --resource-group $RESOURCE_GROUP --query oidcIssuerProfile.issuerUrl -o tsv) \\\n  --subject system:serviceaccount:kafka-backup:kafka-backup \\\n  --audience api://AzureADTokenExchange\n'})}),"\n",(0,t.jsx)(n.p,{children:"Kubernetes ServiceAccount:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: kafka-backup\n  namespace: kafka-backup\n  annotations:\n    azure.workload.identity/client-id: <client-id>\n  labels:\n    azure.workload.identity/use: "true"\n'})}),"\n",(0,t.jsx)(n.h2,{id:"lifecycle-management",children:"Lifecycle Management"}),"\n",(0,t.jsx)(n.h3,{id:"set-up-lifecycle-policy",children:"Set Up Lifecycle Policy"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Create lifecycle policy JSON\ncat > lifecycle-policy.json << \'EOF\'\n{\n  "rules": [\n    {\n      "enabled": true,\n      "name": "archive-old-backups",\n      "type": "Lifecycle",\n      "definition": {\n        "actions": {\n          "baseBlob": {\n            "tierToCool": {\n              "daysAfterModificationGreaterThan": 30\n            },\n            "tierToArchive": {\n              "daysAfterModificationGreaterThan": 90\n            },\n            "delete": {\n              "daysAfterModificationGreaterThan": 365\n            }\n          }\n        },\n        "filters": {\n          "blobTypes": ["blockBlob"],\n          "prefixMatch": ["kafka-backups/production/"]\n        }\n      }\n    }\n  ]\n}\nEOF\n\n# Apply policy\naz storage account management-policy create \\\n  --account-name $STORAGE_ACCOUNT \\\n  --resource-group $RESOURCE_GROUP \\\n  --policy @lifecycle-policy.json\n'})}),"\n",(0,t.jsx)(n.h2,{id:"access-tiers",children:"Access Tiers"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Tier"}),(0,t.jsx)(n.th,{children:"Use Case"}),(0,t.jsx)(n.th,{children:"Access Time"}),(0,t.jsx)(n.th,{children:"Cost"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Hot"}),(0,t.jsx)(n.td,{children:"Frequent access"}),(0,t.jsx)(n.td,{children:"Instant"}),(0,t.jsx)(n.td,{children:"$$$"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Cool"}),(0,t.jsx)(n.td,{children:"Infrequent (30+ days)"}),(0,t.jsx)(n.td,{children:"Instant"}),(0,t.jsx)(n.td,{children:"$$"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Archive"}),(0,t.jsx)(n.td,{children:"Rare access (180+ days)"}),(0,t.jsx)(n.td,{children:"Hours"}),(0,t.jsx)(n.td,{children:"$"})]})]})]}),"\n",(0,t.jsx)(n.h2,{id:"geo-replication",children:"Geo-Replication"}),"\n",(0,t.jsx)(n.p,{children:"For disaster recovery:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Create storage account with geo-redundancy\naz storage account create \\\n  --name $STORAGE_ACCOUNT \\\n  --resource-group $RESOURCE_GROUP \\\n  --location $LOCATION \\\n  --sku Standard_GRS \\\n  --kind StorageV2\n"})}),"\n",(0,t.jsx)(n.p,{children:"Redundancy options:"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"SKU"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"Standard_LRS"})}),(0,t.jsx)(n.td,{children:"Locally redundant"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"Standard_ZRS"})}),(0,t.jsx)(n.td,{children:"Zone redundant"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"Standard_GRS"})}),(0,t.jsx)(n.td,{children:"Geo-redundant"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"Standard_RAGRS"})}),(0,t.jsx)(n.td,{children:"Read-access geo-redundant"})]})]})]}),"\n",(0,t.jsx)(n.h2,{id:"security-best-practices",children:"Security Best Practices"}),"\n",(0,t.jsx)(n.h3,{id:"enable-encryption",children:"Enable Encryption"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Enable infrastructure encryption\naz storage account update \\\n  --name $STORAGE_ACCOUNT \\\n  --resource-group $RESOURCE_GROUP \\\n  --require-infrastructure-encryption\n"})}),"\n",(0,t.jsx)(n.h3,{id:"configure-firewall",children:"Configure Firewall"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Restrict to specific VNet\naz storage account network-rule add \\\n  --account-name $STORAGE_ACCOUNT \\\n  --resource-group $RESOURCE_GROUP \\\n  --vnet-name my-vnet \\\n  --subnet my-subnet\n\n# Set default action to deny\naz storage account update \\\n  --name $STORAGE_ACCOUNT \\\n  --resource-group $RESOURCE_GROUP \\\n  --default-action Deny\n"})}),"\n",(0,t.jsx)(n.h3,{id:"enable-soft-delete",children:"Enable Soft Delete"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"az storage blob service-properties delete-policy update \\\n  --account-name $STORAGE_ACCOUNT \\\n  --enable true \\\n  --days-retained 30\n"})}),"\n",(0,t.jsx)(n.h2,{id:"testing",children:"Testing"}),"\n",(0,t.jsx)(n.h3,{id:"verify-access",children:"Verify Access"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Test with Azure CLI\naz storage blob list \\\n  --account-name $STORAGE_ACCOUNT \\\n  --container-name kafka-backups \\\n  --auth-mode login\n\n# Test write\necho "test" | az storage blob upload \\\n  --account-name $STORAGE_ACCOUNT \\\n  --container-name kafka-backups \\\n  --name test.txt \\\n  --data @- \\\n  --auth-mode login\n\n# Clean up\naz storage blob delete \\\n  --account-name $STORAGE_ACCOUNT \\\n  --container-name kafka-backups \\\n  --name test.txt \\\n  --auth-mode login\n'})}),"\n",(0,t.jsx)(n.h3,{id:"test-from-application",children:"Test from Application"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Run backup\nkafka-backup backup --config backup.yaml\n\n# List backups\nkafka-backup list --path azure://$STORAGE_ACCOUNT/kafka-backups/production/daily\n"})}),"\n",(0,t.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,t.jsx)(n.h3,{id:"authentication-errors",children:"Authentication Errors"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Check credentials\naz storage account keys list --account-name $STORAGE_ACCOUNT\n\n# Test with connection string\naz storage container list --connection-string "$AZURE_STORAGE_CONNECTION_STRING"\n'})}),"\n",(0,t.jsx)(n.h3,{id:"network-errors",children:"Network Errors"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Check firewall rules\naz storage account network-rule list \\\n  --account-name $STORAGE_ACCOUNT \\\n  --resource-group $RESOURCE_GROUP\n\n# Test connectivity\ncurl -v https://$STORAGE_ACCOUNT.blob.core.windows.net/\n"})}),"\n",(0,t.jsx)(n.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"../../reference/config-yaml",children:"Configuration Reference"})," - All storage options"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"../../guides/backup-to-s3",children:"Backup Guide"})," - Backup walkthrough"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"../../guides/security-setup",children:"Security Setup"})," - Security configuration"]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453:(e,n,a)=>{a.d(n,{R:()=>c,x:()=>s});var r=a(6540);const t={},i=r.createContext(t);function c(e){const n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:c(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);